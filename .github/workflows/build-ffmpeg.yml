name: Build FFmpeg for Termux

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK_VERSION: r26d
      ANDROID_API_LEVEL: 24
      ARCH: armeabi-v7a
      PREFIX: /data/data/com.termux/files/usr

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Download and extract Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
        unzip android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
        export ANDROID_NDK_HOME=$GITHUB_WORKSPACE/android-ndk-${{ env.ANDROID_NDK_VERSION }}
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

    - name: Verify all clang executables
      run: |
        find $ANDROID_NDK_HOME -name '*clang*' -type f

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y autoconf automake build-essential cmake git libtool pkg-config texinfo zlib1g-dev yasm llvm

    - name: Install gas-preprocessor
      run: |
        git clone https://github.com/FFmpeg/gas-preprocessor
        sudo cp gas-preprocessor/gas-preprocessor.pl /usr/local/bin/
        sudo chmod +x /usr/local/bin/gas-preprocessor.pl

    - name: Set up environment variables
      run: |
        export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
        export TARGET=armv7a-linux-androideabi
        export API=${{ env.ANDROID_API_LEVEL }}
        export AR=$TOOLCHAIN/bin/arm-linux-androideabi-ar
        export AS=$TOOLCHAIN/bin/arm-linux-androideabi-as
        export CC=$ANDROID_NDK_HOME/build/core/toolchains/arm-linux-androideabi-clang
        export CXX=$ANDROID_NDK_HOME/build/core/toolchains/arm-linux-androideabi-clang++
        export LD=$TOOLCHAIN/bin/arm-linux-androideabi-ld
        export STRIP=$TOOLCHAIN/bin/llvm-strip
        export NM=$TOOLCHAIN/bin/llvm-nm
        export CROSS_PREFIX=$TOOLCHAIN/bin/arm-linux-androideabi-
        export PKG_CONFIG=$ANDROID_NDK_HOME/prebuilt/linux-x86_64/bin/pkg-config
        export PATH="/usr/local/bin:$PATH"
        export GASPP="/usr/local/bin/gas-preprocessor.pl"
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "API=$API" >> $GITHUB_ENV
        echo "AR=$AR" >> $GITHUB_ENV
        echo "AS=$AS" >> $GITHUB_ENV
        echo "CC=$CC" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "LD=$LD" >> $GITHUB_ENV
        echo "STRIP=$STRIP" >> $GITHUB_ENV
        echo "NM=$NM" >> $GITHUB_ENV
        echo "CROSS_PREFIX=$CROSS_PREFIX" >> $GITHUB_ENV
        echo "PKG_CONFIG=$PKG_CONFIG" >> $GITHUB_ENV
        echo "PATH=/usr/local/bin:$PATH" >> $GITHUB_ENV
        echo "GASPP=/usr/local/bin/gas-preprocessor.pl" >> $GITHUB_ENV

    - name: Verify gas-preprocessor
      run: |
        if command -v gas-preprocessor.pl > /dev/null; then
          echo "gas-preprocessor found at: $(command -v gas-preprocessor.pl)"
        else
          echo "gas-preprocessor not found"
        fi

    - name: Verify GNU assembler
      run: |
        if command -v as > /dev/null; then
          echo "GNU assembler found at: $(command -v as)"
        else
          echo "GNU assembler not found"
        fi

    - name: Verify arm-linux-androideabi-clang
      run: |
        if command -v $CC > /dev/null; then
          echo "arm-linux-androideabi-clang found at: $(command -v $CC)"
        else
          echo "arm-linux-androideabi-clang not found"
        fi

    - name: Download FFmpeg source code
      run: |
        wget https://ffmpeg.org/releases/ffmpeg-6.1.1.tar.xz
        tar -xvf ffmpeg-6.1.1.tar.xz
        cd ffmpeg-6.1.1

    - name: Configure FFmpeg
      run: |
        cd ffmpeg-6.1.1
        ./configure \
          --arch=armeabi-v7a \
          --as=$CC \
          --cc=$CC \
          --cxx=$CXX \
          --nm=$NM \
          --pkg-config=$PKG_CONFIG \
          --strip=$STRIP \
          --cross-prefix=$CROSS_PREFIX \
          --disable-indevs \
          --disable-outdevs \
          --enable-indev=lavfi \
          --disable-static \
          --disable-symver \
          --enable-cross-compile \
          --enable-gnutls \
          --enable-gpl \
          --enable-version3 \
          --enable-jni \
          --enable-lcms2 \
          --enable-libaom \
          --enable-libass \
          --enable-libbluray \
          --enable-libdav1d \
          --enable-libfreetype \
          --enable-libgme \
          --enable-libmp3lame \
          --enable-libopencore-amrnb \
          --enable-libopencore-amrwb \
          --enable-libopenmpt \
          --enable-libopus \
          --enable-librav1e \
          --enable-libsoxr \
          --enable-libsrt \
          --enable-libssh \
          --enable-libsvtav1 \
          --enable-libtheora \
          --enable-libv4l2 \
          --enable-libvidstab \
          --enable-libvo-amrwbenc \
          --enable-libvorbis \
          --enable-libvpx \
          --enable-libwebp \
          --enable-libx264 \
          --enable-libx265 \
          --enable-libxml2 \
          --enable-libxvid \
          --enable-libzimg \
          --enable-mediacodec \
          --enable-opencl \
          --enable-shared \
          --prefix=${{ env.PREFIX }} \
          --target-os=android \
          --extra-libs=-landroid-glob \
          --disable-vulkan \
          --enable-neon \
          --disable-libfdk-aac

    - name: Build FFmpeg
      run: |
        cd ffmpeg-6.1.1
        make -j$(nproc)
        make install

    - name: Upload FFmpeg binary
      uses: actions/upload-artifact@v2
      with:
        name: ffmpeg-binary
        path: ${{ env.PREFIX }}/bin/ffmpeg
