name: Build FFmpeg with x264 for Android

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK_ROOT: /usr/local/lib/android/sdk/ndk/25.2.9519653
      API: 24
      INSTALL_DIR: ${{ github.workspace }}/external_libs
      PREFIX: ${{ github.workspace }}/android/armeabi-v7a
      ARCH: arm
      TERMUX: armv7a-linux-androideabi

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.5

    - name: Setup environment variables
      run: |
        echo "ANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }}" >> $GITHUB_ENV
        echo "API=${{ env.API }}" >> $GITHUB_ENV

    - name: Download FFmpeg source
      run: |
        wget -O - https://www.ffmpeg.org/releases/ffmpeg-7.0.1.tar.xz | tar -xJv -C $GITHUB_WORKSPACE

    - name: Compile and install x264 for armv7a
      run: |
        mkdir -p $INSTALL_DIR
        git clone https://code.videolan.org/videolan/x264.git
        cd x264
        
        patch -p0 < ../x264_fixes.patch
        
        export NDK=$ANDROID_NDK_ROOT
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export SYSROOT=$TOOLCHAIN/sysroot
        export TOOLNAME_BASE="armv7a-linux-androideabi"
        export COMPILER_BASE="armv7a-linux-androideabi"
        export HOST="armv7a-linux-androideabi"
        export CROSS_PREFIX=$TOOLCHAIN/bin/$TOOLNAME_BASE-
        export CC=$TOOLCHAIN/bin/$COMPILER_BASE$API-clang
        export CXX=$TOOLCHAIN/bin/$COMPILER_BASE$API-clang++
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export STRINGS=$TOOLCHAIN/bin/llvm-strings
        export CFLAGS="-DANDROID -Wall -fPIC"
    
        ./configure --prefix=$INSTALL_DIR \
                    --enable-static \
                    --enable-pic \
                    --disable-asm \
                    --host=$HOST \
                    --cross-prefix=$CROSS_PREFIX \
                    --sysroot=$SYSROOT \
                    --extra-cflags="$CFLAGS"
        make -j$(nproc)
        make install
        echo "PKG_CONFIG_PATH=$INSTALL_DIR/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Set environment variables for FFmpeg
      run: |
        echo "X264_INCLUDE=$INSTALL_DIR/include" >> $GITHUB_ENV
        echo "X264_LIB=$INSTALL_DIR/lib" >> $GITHUB_ENV

    - name: Configure FFmpeg for armv7a with x264
      run: |
        export NDK=$ANDROID_NDK_ROOT
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export SYSROOT=$TOOLCHAIN/sysroot
        export CC=$TOOLCHAIN/bin/$TERMUX$API-clang
        export CXX=$TOOLCHAIN/bin/$TERMUX$API-clang++
        export CROSS_PREFIX=$TOOLCHAIN/bin/$TERMUX-
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export NM=$TOOLCHAIN/bin/llvm-nm
        export PKG_CONFIG=/usr/bin/pkg-config
        export STRIP=$TOOLCHAIN/bin/llvm-strip
        
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        ./configure \
          --arch="$ARCH" \
          --nm="$NM" \
          --cc="$CC" \
          --ar="$AR" \
          --cxx="$CXX" \
          --ranlib="$RANLIB" \
          --strip="$STRIP" \
          --cross-prefix="$CROSS_PREFIX" \
          --disable-indevs \
          --disable-outdevs \
          --disable-shared \
          --disable-symver \
          --pkg-config="$PKG_CONFIG" \
          --enable-static \
          --enable-cross-compile \
          --enable-libx264 \
          --enable-neon \
          --enable-gpl \
          --prefix="$PREFIX" \
          --target-os=android \
          --disable-vulkan \
          --sysroot="$SYSROOT" \
          --disable-libfdk-aac

    - name: Build FFmpeg for armv7a
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        make -j$(nproc)
        make install

    - name: Upload FFmpeg Build Artifact for armv7a
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-armeabi-v7a
        path: ${{ github.workspace }}/android/armeabi-v7a/**
