name: Build FFmpeg with x264 for Android

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.5
      
    - name: Setup environment variables
      run: |
        echo "ANDROID_NDK_ROOT=/usr/local/lib/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "API=24" >> $GITHUB_ENV
        echo "TOOLCHAIN=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
        echo "SYSROOT=$TOOLCHAIN/sysroot" >> $GITHUB_ENV

    - name: Download FFmpeg source
      run: |
        wget -O - https://www.ffmpeg.org/releases/ffmpeg-7.0.1.tar.xz | tar -xJv -C $GITHUB_WORKSPACE

    - name: Compile and install x264 for armv7a
      run: |
        INSTALL_DIR=$GITHUB_WORKSPACE/external_libs
        mkdir -p $INSTALL_DIR
        git clone https://code.videolan.org/videolan/x264.git
        cd x264
        
        patch -p0 < ../x264_fixes.patch
        
        # x264 编译环境变量
        export NDK=${{ env.ANDROID_NDK_ROOT }}
        export TOOLCHAIN=${{ env.TOOLCHAIN }}
        export SYSROOT=${{ env.SYSROOT }}
        export TOOLNAME_BASE="armv7a-linux-androideabi" 
        export COMPILER_BASE="armv7a-linux-androideabi" 
        export HOST="armv7a-linux-androideabi" 
        export CROSS_PREFIX=$TOOLCHAIN/bin/$TOOLNAME_BASE-
        export CC=$TOOLCHAIN/bin/$COMPILER_BASE${{ env.API }}-clang
        export CXX=$TOOLCHAIN/bin/$COMPILER_BASE${{ env.API }}-clang++
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export STRINGS=$TOOLCHAIN/bin/llvm-strings
        export CFLAGS="-DANDROID -Wall -fPIC"
    
        ./configure --prefix=$INSTALL_DIR \
                    --enable-static \
                    --enable-pic \
                    --disable-asm \
                    --host=$HOST \
                    --cross-prefix=$CROSS_PREFIX \
                    --sysroot=$SYSROOT \
                    --extra-cflags="$CFLAGS"
        make -j$(nproc)
        make install
        echo "PKG_CONFIG_PATH=$GITHUB_WORKSPACE/external_libs/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Configure FFmpeg for armv7a with x264
      run: |
        # FFmpeg 编译环境变量
        export ARCH=arm
        export PREFIX=$GITHUB_WORKSPACE/android/armeabi-v7a
        export TERMUX=armv7a-linux-androideabi 
        export NDK=${{ env.ANDROID_NDK_ROOT }}
        export TOOLCHAIN=${{ env.TOOLCHAIN }}
        export SYSROOT=${{ env.SYSROOT }}
        export CC=$TOOLCHAIN/bin/$TERMUX${{ env.API }}-clang
        export CXX=$TOOLCHAIN/bin/$TERMUX${{ env.API }}-clang++
        export CROSS_PREFIX=$TOOLCHAIN/bin/$TERMUX-
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export NM=$TOOLCHAIN/bin/llvm-nm
        export PKG_CONFIG=/usr/bin/pkg-config
        export STRIP=$TOOLCHAIN/bin/llvm-strip
        
        cd $GITHUB_WORKSPACE/ffmpeg-6.1.1
        ./configure \
          --arch="$ARCH" \
          --nm="$NM" \
          --cc="$CC" 
          --ar="$AR" 
          --cxx="$CXX" 
          --ranlib="$RANLIB" 
          --strip="$STRIP" 
          --cross-prefix="$CROSS_PREFIX" \
          --disable-indevs \
          --disable-outdevs \
          --disable-shared \
          --disable-symver \
          --pkg-config="$PKG_CONFIG" \
          --enable-static \
          --enable-cross-compile \
          --enable-libx264 \
          --enable-neon \
          --enable-gpl \
          --prefix="$PREFIX" \
          --target-os=android \
          --disable-vulkan \
          --sysroot="$SYSROOT" \
          --disable-libfdk-aac

    - name: Build FFmpeg for armv7a
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-6.1.1
        make -j$(nproc)
        make install

    - name: Upload FFmpeg Build Artifact for armv7a
      if: ${{ always() }} 
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-armeabi-v7a
        path: ${{ github.workspace }}/android/armeabi-v7a/**
