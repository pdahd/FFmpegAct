name: Build FFmpeg with x264 for Android

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.5
      
    - name: Setup environment variables
      run: |
        echo "TT=armv7a-linux-androideabi" >> $GITHUB_ENV
        echo "NDK=/usr/local/lib/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
        
    - name: Download FFmpeg source
      run: |
        wget -O - https://www.ffmpeg.org/releases/ffmpeg-7.0.1.tar.xz | tar -xJv -C $GITHUB_WORKSPACE
    
    - name: Copy filter and apply patch
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        cp $GITHUB_WORKSPACE/xfade-easing.h libavfilter/
        cp $GITHUB_WORKSPACE/vf_xfade.c libavfilter/vf_xfade.c
        diff $GITHUB_WORKSPACE/vf_xfade.c libavfilter/vf_xfade.c
    
    - name: Check framesync.c line 91
      if: false
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        find . -name vf_blend.c
        find . -name vf_xfade.c
        sed -n '91p' libavfilter/framesync.c
    
    - name: Find AVFilter struct definition
      if: false
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        grep -rn 'typedef struct AVFilter' --include='*.h'
        cat libavfilter/avfilter.h
    
    - name: 看看
      if: false
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        cat libavfilter/formats.h
    
    - name: Show context around target lines in Makefile and allfilters.c
      if: false
      run: |
        grep -C 5 "CONFIG_ZSCALE_FILTER" $GITHUB_WORKSPACE/ffmpeg-7.0.1/libavfilter/Makefile
        echo "----------------------------------------"
        grep -C 5 "ff_vf_zscale" $GITHUB_WORKSPACE/ffmpeg-7.0.1/libavfilter/allfilters.c
    
    - name: 444 content
      if: false
      run: |
        grep -Ri "opengl" $GITHUB_WORKSPACE/ffmpeg-7.0.1
        
    
    - name: Modify configure script for OpenGL ES
      if: false
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        sed -i '/enabled opengl            && { check_lib opengl GL\/glx.h glXGetProcAddress "-lGL" ||/,/^                             }/c\enabled opengl            && { check_lib opengl "GLES2\/gl2.h" glGetError "-lGLESv2" || check_lib opengl "EGL/egl.h" eglGetDisplay "-lEGL" || die "ERROR: opengl not found."; }' configure
    
    - name: Print FFmpeg configure script content
      if: false
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        cat configure
    
    - name: 查一
      if: false
      run: |
        ls -R /usr/local/lib/android/sdk/ndk/25.2.9519653/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include
        find $NDK -name "*.pc"
    
    - name: 查2
      if: false
      run: |
        find /usr/local/lib/android/sdk/ndk/25.2.9519653 -name libGLESv2.so
    
    - name: Copy gltransition filter source
      if: false
      run: |
        cp $GITHUB_WORKSPACE/vf_gltransition.c $GITHUB_WORKSPACE/ffmpeg-7.0.1/libavfilter/
        # 检查文件是否成功复制
        ls $GITHUB_WORKSPACE/ffmpeg-7.0.1/libavfilter/vf_gltransition.c
        ls $NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/arm-linux-androideabi/24
        find /usr/local/lib/android/sdk/ndk/25.2.9519653 -name pkgconfig
        find /usr/local/lib/android/sdk/ndk/25.2.9519653 -name .pc
        
        find /usr/local/lib/android/sdk/ndk/25.2.9519653 -name libGLESv2.so
    
    - name: Apply gltransition patch
      if: false
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        git apply $GITHUB_WORKSPACE/ffmpeg.diff
        # 检查是否有未应用的修改
        git diff --exit-code # 如果没有输出，说明补丁已成功应用
    
    - name: 显示可用的FFmpeg配置选项
      if: false
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        cp $GITHUB_WORKSPACE/vf_gltransition.c libavfilter/
        ls libavfilter/vf_gltransition.c
        ./configure --help
    
    - name: Customize FFmpeg banner in opt_common.c with green color
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        BUILD_DATE=$(date +"%Y-%m-%d")
        sed -i '/void show_banner(int argc, char \*\*argv, const OptionDef \*options)/,/^}/c\
        void show_banner(int argc, char **argv, const OptionDef *options) {\n\
        av_log(NULL, AV_LOG_INFO, "FFmpeg %s - arm static build © 2000-2024 FFmpeg Team.\\nBuilt by pdahd (https://github.com/pdahd) on %s.\\n", FFMPEG_VERSION, "'$BUILD_DATE'");\n\
        }' fftools/opt_common.c
    
    - name: Upload blend and xfade filter source files
      if: false
      uses: actions/upload-artifact@v4
      with:
        name: avfilter.h-and-formats.h
        path: |
          ffmpeg-7.0.1/libavfilter/avfilter.h
          ffmpeg-7.0.1/libavfilter/formats.h
    
    - name: Upload blend and xfade filter source files
      if: false
      uses: actions/upload-artifact@v4
      with:
        name: blend-and-xfade-source
        path: |
          ffmpeg-7.0.1/libavfilter/vf_blend.c
          ffmpeg-7.0.1/libavfilter/vf_xfade.c
    
    - name: Compile and install x264 for armv7a
      run: |
        git clone https://code.videolan.org/videolan/x264.git
        cd x264
        patch -p0 < ../x264_fixes.patch
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export SYSROOT=$TOOLCHAIN/sysroot 
        export CC=$TOOLCHAIN/bin/${TT}24-clang
        export CXX=$TOOLCHAIN/bin/${TT}24-clang++
        export CROSS_PREFIX=$TOOLCHAIN/bin/llvm-
        export CFLAGS="-DANDROID -Wall -fPIC" 
        export PREFIX=/usr/local
        export HOST=$TT
        
        ./configure --prefix="$PREFIX" \
                    --enable-static \
                    --enable-pic \
                    --disable-asm \
                    --host="$HOST" \
                    --cross-prefix="$CROSS_PREFIX" \
                    --sysroot="$SYSROOT" \
                    --extra-cflags="$CFLAGS"
        make -j$(nproc)
        sudo make install

    - name: Copy filter and apply patch
      if: false
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        cp $GITHUB_WORKSPACE/vf_gltransition.c libavfilter/
        echo "vf_gltransition.c copied to: $(pwd)/libavfilter/vf_gltransition.c"
        patch -p0 < ../ff.patch 
    
    - name: Show around target lines in Makefile and allfilters.c
      if: false
      run: |
        grep -C 5 "CONFIG_ZSCALE_FILTER" $GITHUB_WORKSPACE/ffmpeg-7.0.1/libavfilter/Makefile
        echo "----------------------------------------"
        grep -C 5 "ff_vf_zscale" $GITHUB_WORKSPACE/ffmpeg-7.0.1/libavfilter/allfilters.c
    
    - name: Check x264 configuration
      if: false
      run: pkg-config --cflags --libs x264
      
    
    - name: Configure FFmpeg for armv7a with x264
      run: |
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export SYSROOT=$TOOLCHAIN/sysroot 
        export CC=$TOOLCHAIN/bin/${TT}24-clang
        export CXX=$TOOLCIN/bin/${TT}24-clang++
        export CROSS_PREFIX=$TOOLCHAIN/bin/llvm-
        export PKG_CONFIG=/usr/bin/pkg-config
        export PREFIX=$GITHUB_WORKSPACE/2024
      
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        ./configure \
          --arch=arm \
          --cc="$CC" \
          --cxx="$CXX" \
          --cross-prefix="$CROSS_PREFIX" \
          --disable-indevs \
          --disable-outdevs \
          --disable-static \
          --disable-symver \
          --pkg-config="$PKG_CONFIG" \
          --enable-shared \
          --enable-libx264 \
          --enable-mediacodec \
          --enable-version3 \
          --enable-jni \
          --enable-indev=lavfi \
          --enable-cross-compile \
          --enable-neon \
          --enable-gpl \
          --prefix="$PREFIX" \
          --target-os=android \
          --disable-vulkan \
          --sysroot="$SYSROOT" 

    - name: Build FFmpeg for armv7a
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg-7.0.1
        make -j$(nproc)
        make install
    
    - name: Copy libx264.so.164 to ffmpeg lib directory
      if: false
      run: cp $GITHUB_WORKSPACE/exlibs/lib/libx264.so.164 ${{ github.workspace }}/2024/lib
    
    - name: List files in lib directory
      if: false
      run: ls -l ${{ github.workspace }}/2024/lib
    
    - name: Upload FFmpeg Build Artifact for armv7a
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-armeabi-v7a
        path: ${{ github.workspace }}/2024/**
    
    - name: Upload Makefile and allfilters.c for download
      if: false
      uses: actions/upload-artifact@v4
      with:
        name: FFmpeg-original-files
        path: |
          ${{ github.workspace }}/ffmpeg-7.0.1/libavfilter/Makefile
          ${{ github.workspace }}/ffmpeg-7.0.1/libavfilter/allfilters.c
