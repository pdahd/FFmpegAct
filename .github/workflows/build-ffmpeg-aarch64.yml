name: Build FFmpeg with x264 for Android

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK_VERSION: r26d

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Download and extract Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
        unzip android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
        echo "ANDROID_NDK_HOME=$GITHUB_WORKSPACE/android-ndk-${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
        
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y autoconf automake build-essential cmake git libtool texinfo zlib1g-dev yasm
        

    - name: Install gas-preprocessor
      run: |
        git clone https://github.com/FFmpeg/gas-preprocessor
        sudo cp gas-preprocessor/gas-preprocessor.pl /usr/local/bin/
        sudo chmod +x /usr/local/bin/gas-preprocessor.pl

    - name: Download FFmpeg source
      run: |
        wget -O - https://www.ffmpeg.org/releases/ffmpeg-6.1.1.tar.xz | tar -xJv -C $GITHUB_WORKSPACE

    - name: List NDK directory structure
      run: |
        echo "Listing NDK directory structure..."
        ls -R $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin
    
    - name: Compile and install x264
      run: |
        INSTALL_DIR=$GITHUB_WORKSPACE/external_libs
        
        mkdir -p $INSTALL_DIR

        git clone https://code.videolan.org/videolan/x264.git
        cd x264
        
        patch -p0 < ../x264_fixes.patch
        
        export API=21
        export NDK=$ANDROID_NDK_HOME
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export SYSROOT=$TOOLCHAIN/sysroot
        export TOOLNAME_BASE="aarch64-linux-android"
        export COMPILER_BASE="aarch64-linux-android"
        export HOST="aarch64-linux-android"
        export CROSS_PREFIX=$TOOLCHAIN/bin/$TOOLNAME_BASE-
        export CC=$TOOLCHAIN/bin/$COMPILER_BASE$API-clang
        export CXX=$TOOLCHAIN/bin/$COMPILER_BASE$API-clang++
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export STRINGS=$TOOLCHAIN/bin/llvm-strings
        export CFLAGS="-DANDROID -Wall -fPIC"
    
        ./configure --prefix=$INSTALL_DIR \
                    --enable-static \
                    --enable-pic \
                    --disable-asm \
                    --host=$HOST \
                    --cross-prefix=$CROSS_PREFIX \
                    --sysroot=$SYSROOT \
                    --extra-cflags="$CFLAGS"
        make -j$(nproc)
        make install
        
        echo "Listing files for x264:"
        find $INSTALL_DIR -type f
        cat $GITHUB_WORKSPACE/external_libs/lib/pkgconfig/x264.pc

    - name: Create pkg-config wrapper
      run: |
        echo '#!/bin/sh' > aarch64-linux-android-pkg-config
        echo 'PKG_CONFIG_LIBDIR=${PKG_CONFIG_LIBDIR} /usr/bin/pkg-config "$@"' >> aarch64-linux-android-pkg-config
        chmod +x aarch64-linux-android-pkg-config
        sudo mv aarch64-linux-android-pkg-config /usr/local/bin/

        export PKG_CONFIG_LIBDIR=$GITHUB_WORKSPACE/external_libs/lib/pkgconfig
        echo "PKG_CONFIG_LIBDIR=$PKG_CONFIG_LIBDIR" >> $GITHUB_ENV
    
    - name: Configure FFmpeg for arm64-v8a with x264
      run: |
        export API=21
        export ARCH=aarch64
        export ABI=arm64-v8a
        export TERMUX=aarch64-linux-android
        export NDK=$ANDROID_NDK_HOME
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export SYSROOT=$TOOLCHAIN/sysroot
        export CC=$TOOLCHAIN/bin/$TERMUX$API-clang
        export CXX=$TOOLCHAIN/bin/$TERMUX$API-clang++
        export CROSS_PREFIX=$TOOLCHAIN/bin/$TERMUX-
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export NM=$TOOLCHAIN/bin/llvm-nm
        
        pkg-config --libs --cflags x264
        
    
        cd $GITHUB_WORKSPACE/ffmpeg-6.1.1
        ./configure \
          --arch=$ARCH \
          --nm=$NM \
          --cc=$CC \
          --cxx=$CXX \
          --cross-prefix=$CROSS_PREFIX \
          --disable-indevs \
          --disable-outdevs \
          --disable-static \
          --disable-symver \
          --enable-cross-compile \
          --enable-neon \
          --enable-gpl \
          --enable-shared \
          --prefix=$GITHUB_WORKSPACE/android/$ABI \
          --target-os=android \
          --disable-vulkan \
          --sysroot=$SYSROOT \
          --disable-libfdk-aac

    - name: Upload config.log
      if: always()
      uses: actions/upload-artifact@v2
      with:
        name: config-log
        path: ffmpeg-6.1.1/ffbuild/config.log
        if-no-files-found: warn
